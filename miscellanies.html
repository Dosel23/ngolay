<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ngolay | Miscellanies</title>
<link rel="stylesheet" href="all_categories.css">
<style>
  /* Search and dropdown styles */
  .header-icons {
    position: relative;
    display: flex;
    align-items: center;
    gap: 15px;
  }
  
  .search-container {
    position: relative;
  }
  
  #search-bar {
    display: none;
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
    width: 200px;
  }
  
  #search-results {
    display: none;
    background: white;
    color: black;
    position: absolute;
    top: 35px;
    right: 0;
    max-height: 300px;
    overflow-y: auto;
    width: 250px;
    border-radius: 5px;
    z-index: 1000;
    padding: 5px;
  }
  
  #search-results div {
    padding: 5px;
    cursor: pointer;
    border-bottom: 1px solid #ddd;
  }
  
  #search-results div:hover {
    background-color: #eee;
  }
  
  .account-dropdown {
    position: relative;
  }
  
  .dropdown-menu {
    display: none;
    position: absolute;
    top: 35px;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    z-index: 1000;
  }
  
  .dropdown-menu a {
    display: block;
    padding: 10px;
    text-decoration: none;
    color: #656283;
  }
  
  .dropdown-menu a:hover {
    background-color: #eee;
  }
</style>
</head>
<body>

<!-- Header Section -->
<header class="header">
  <div class="logo"><img src="logo.png" alt="Ngolay Logo"></div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="categories.html" class="active">Categories</a>
    <a href="cart.html">Cart</a>
    <a href="wishlist.html">Wishlist</a>
  </nav>
  <div class="header-icons">
    <!-- Search -->
    <div class="search-container">
      <i class="search-icon" id="search-toggle">üîç</i>
      <input type="text" id="search-bar" placeholder="Search products...">
      <div id="search-results"></div>
    </div>
    
    <!-- Account Dropdown -->
    <div class="account-dropdown">
      <i class="account-icon" id="account-toggle">üë§</i>
      <div class="dropdown-menu" id="account-menu">
        <a href="account.html">Account</a>
        <a href="login.html">Log In</a>
        <a href="logout.html">Log Out</a>
      </div>
    </div>
  </div>
</header>

<!-- Products Section -->
<section class="clothes">
  <h2>MISCELLANIES</h2>
  <div class="product-grid" id="product-grid"><!-- Products dynamically loaded --></div>
</section>

<!-- Footer Section -->
<footer class="footer">
  <div class="footer-logo"><img src="logo.png" alt="Ngolay Logo"></div>
  <div class="footer-links">
    <div class="footer-section">
      <h3>Company</h3>
      <a href="#about">About Us</a>
      <a href="#contact">Contact</a>
    </div>
    <div class="footer-section">
      <h3>Our Information</h3>
      <a href="#terms">Terms and Condition</a>
      <a href="#faq">FAQ</a>
    </div>
  </div>
  <div class="footer-bottom"><p>¬© 2025 Ngolay. All Rights Reserved</p></div>
</footer>

<!-- Firebase SDK + Firestore -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCJfAyK_wma5RaTv6DODRgCDExnFuLXK00",
  authDomain: "ngolay-project.firebaseapp.com",
  projectId: "ngolay-project",
  storageBucket: "ngolay-project.appspot.com",
  messagingSenderId: "236457585222",
  appId: "1:236457585222:web:9133bb46a97ef678d23847",
  measurementId: "G-34BC1Z5PPM"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const grid = document.getElementById("product-grid");

let currentUserUid = null;
let allProducts = [];

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUserUid = user.uid;
  }
});

// Load Beauty products
async function loadProducts() {
  grid.innerHTML = '<p>Loading products...</p>';

  const productsCol = collection(db, "products");
  const snapshot = await getDocs(productsCol);
  grid.innerHTML = '';

  // Store all products for search
  allProducts = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

  snapshot.forEach(docSnap => {
    const product = docSnap.data();

    // Only show Beauty category
    if (product.category === "Miscellanies") {
      const card = document.createElement("div");
      card.className = "product-card";

      // Use Base64 if available, else URL, else placeholder
      const imageSrc = product.imageBase64
        ? `data:image/jpeg;base64,${product.imageBase64}`
        : (product.images && product.images[0]) || "placeholder.jpg";

      card.innerHTML = `
        <img src="${imageSrc}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>Nu. ${product.price.toFixed(2)}</p>
        <div class="product-actions">
          <button class="cart-btn">üõí</button>
          <button class="wishlist-btn">‚ù§Ô∏è</button>
        </div>
      `;

      // Product detail navigation
      card.addEventListener("click", e => {
        if(e.target.closest(".product-actions")) return;
        window.location.href = `product_detail.html?id=${docSnap.id}`;
      });

      // Add to Cart
      card.querySelector(".cart-btn").addEventListener("click", async e => {
        e.preventDefault(); e.stopPropagation();
        if (!currentUserUid) {
          alert('Please log in to add to cart!');
          return;
        }
        
        // Check if product already in cart
        const cartQuery = query(
          collection(db, "cart"), 
          where("userId", "==", currentUserUid),
          where("id", "==", docSnap.id)
        );
        const cartSnapshot = await getDocs(cartQuery);
        
        if (!cartSnapshot.empty) {
          alert(`${product.name} is already in your cart!`);
          return;
        }
        
        await addDoc(collection(db, "cart"), { 
          ...product, 
          id: docSnap.id,
          quantity: 1,
          userId: currentUserUid,
          addedAt: new Date()
        });
        alert(`${product.name} added to cart!`);
      });

      // Add to Wishlist
      card.querySelector(".wishlist-btn").addEventListener("click", async e => {
        e.preventDefault(); e.stopPropagation();
        if (!currentUserUid) {
          alert('Please log in to add to wishlist!');
          return;
        }
        
        // Check if product already in wishlist
        const wishlistQuery = query(
          collection(db, "wishlist"), 
          where("userId", "==", currentUserUid),
          where("id", "==", docSnap.id)
        );
        const wishlistSnapshot = await getDocs(wishlistQuery);
        
        if (!wishlistSnapshot.empty) {
          alert(`${product.name} is already in your wishlist!`);
          return;
        }
        
        await addDoc(collection(db, "wishlist"), {
          ...product,
          id: docSnap.id,
          userId: currentUserUid,
          addedAt: new Date()
        });
        alert(`${product.name} added to wishlist!`);
      });

      grid.appendChild(card);
    }
  });
}

// Search functionality
const searchToggle = document.getElementById('search-toggle');
const searchBar = document.getElementById('search-bar');
const searchResults = document.getElementById('search-results');

searchToggle.addEventListener('click', () => {
  searchBar.style.display = searchBar.style.display === 'block' ? 'none' : 'block';
  if(searchBar.style.display === 'block') searchBar.focus();
});

searchBar.addEventListener('input', () => {
  const queryText = searchBar.value.trim().toLowerCase();
  searchResults.innerHTML = '';
  if (!queryText) { searchResults.style.display = 'none'; return; }

  const matched = allProducts.filter(p => 
    p.name.toLowerCase().includes(queryText) || 
    (p.category && p.category.toLowerCase().includes(queryText))
  );

  if (matched.length === 0) searchResults.innerHTML = '<div>No products found.</div>';
  else matched.forEach(p => {
    const div = document.createElement('div');
    div.textContent = `${p.name} (${p.category})`;
    div.addEventListener('click', () => {
      window.location.href = `product_detail.html?id=${p.id}`;
    });
    searchResults.appendChild(div);
  });
  searchResults.style.display = 'block';
});

// Account dropdown
const accountToggle = document.getElementById('account-toggle');
const accountMenu = document.getElementById('account-menu');

accountToggle.addEventListener('click', e => {
  e.stopPropagation();
  accountMenu.style.display = accountMenu.style.display === 'block' ? 'none' : 'block';
});

document.addEventListener('click', e => {
  if(accountMenu.style.display === 'block' && !accountMenu.contains(e.target) && e.target !== accountToggle){
    accountMenu.style.display = 'none';
  }
});

loadProducts();
</script>
</body>
</html>
