<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>College Market</title>
<link rel="stylesheet" href="all_categories.css">
<style>
/* Hero Section */
.hero{display:flex;justify-content:space-between;align-items:center;padding:60px 80px;background:linear-gradient(90deg,#656283 50%,#656283 50%);gap:40px;flex-wrap:wrap;}
.hero-text{max-width:50%;display:flex;flex-direction:column;justify-content:center;gap:20px;color:white;}
.hero-text h1{font-size:2.2em;line-height:1.3;}
.hero-buttons{display:flex;gap:15px;margin-top:10px;flex-wrap:wrap;}
.btn{background:white;border:2px solid white;padding:10px 20px;border-radius:30px;text-decoration:none;color:#656283;font-weight:bold;transition:0.3s;}
.btn:hover{background:#656283;color:white;}
.hero-image img{width:450px;object-fit:cover;border-radius:10px;}

/* Featured Products */
.featured .product-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:40px;}
.featured .product-card{background-color:white;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.1);overflow:hidden;display:flex;flex-direction:column;align-items:center;text-align:center;}
.featured .product-card img{width:100%;height:200px;object-fit:cover;}
.featured .product-card h3{margin:10px 0 5px 0;}
.featured .product-card p{margin-bottom:10px;font-weight:bold;}
.product-actions{display:flex;justify-content:center;gap:10px;margin-bottom:10px;}

/* About Us */
.about-us{display:flex;align-items:center;justify-content:center;padding:60px 80px;background-color:#D9D9D9;position:relative;overflow:hidden;height:400px;flex-wrap:wrap;}
.about-images{display:flex;position:relative;height:100%;justify-content:center;}
.about-images .img1{height:100%;width:260px;object-fit:cover;border-radius:10px;}
.about-images .img2{position:absolute;left:200px;top:50px;width:200px;height:300px;object-fit:cover;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,0.2);}
.about-content{margin-left:450px;max-width:400px;position:relative;}
.about-content h2{margin-bottom:15px;font-size:1.8em;}
.about-content p{margin-bottom:60px;line-height:1.5;}
.about-btn{position:absolute;bottom:0;left:0;background:#8C89A6;border:2px solid #8C89A6;padding:8px 18px;border-radius:30px;text-decoration:none;color:white;font-weight:bold;transition:0.3s;}
.about-btn:hover{background:#111;color:white;}

/* Search Results */
#search-results { display: none; background: white; color: black; position: absolute; top: 35px; right: 0; max-height: 300px; overflow-y: auto; width: 250px; border-radius: 5px; z-index: 20; padding: 5px; }
#search-results div { padding: 5px; cursor: pointer; border-bottom: 1px solid #ddd; }
#search-results div:hover { background-color: #eee; }

/* Notification Bell Styles */
.notification-bell { position: relative; cursor: pointer; font-size: 1.5em; margin-right: 15px; }
.notification-count { position: absolute; top: -8px; right: -8px; background: #ff4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7em; display: flex; align-items: center; justify-content: center; font-weight: bold; }

/* Toast Notification */
#global-notification { display: none; position: fixed; top: 20px; right: 20px; background: #656283; color: white; padding: 15px 25px; border-radius: 8px; font-weight: bold; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.3); max-width: 400px; word-wrap: break-word; }

/* ---------------- Responsive Adjustments ---------------- */
@media (max-width: 1024px){
  .hero{flex-direction:column;align-items:center;padding:40px 20px;}
  .hero-text{max-width:100%;text-align:center;}
  .hero-buttons{justify-content:center;}
  .hero-image img{width:100%;max-width:350px;}
  .featured .product-grid{grid-template-columns:repeat(2,1fr);}
  .about-us{height:auto;padding:40px 20px;}
  .about-images{position:relative;flex-direction:column;height:auto;margin-bottom:20px;}
  .about-images .img1,.about-images .img2{position:static;width:80%;height:auto;margin:10px 0;}
  .about-content{margin-left:0;max-width:100%;text-align:center;}
  .about-btn{position:static;margin-top:10px;}
}

@media (max-width: 600px){
  .featured .product-grid{grid-template-columns:1fr;}
  .hero-text h1{font-size:1.8em;}
  .btn{padding:8px 15px;font-size:0.9em;}
}

@media (max-width: 400px){
  .hero-text h1{font-size:1.5em;}
  .hero-buttons{flex-direction:column;gap:10px;}
  .btn{padding:6px 12px;font-size:0.85em;}
  .featured .product-card h3{font-size:1em;}
  .featured .product-card p{font-size:0.9em;}
}
</style>
</head>
<body>

<!-- Toast Notification -->
<div id="global-notification"></div>

<!-- HEADER with search & dropdown -->
<header class="header">
  <div class="logo"><img src="logo.png" alt="Ngolay Logo"></div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="categories.html">Categories</a>
    <a href="cart.html">Cart</a>
    <a href="wishlist.html">Wishlist</a>
  </nav>
  <div class="header-icons">
    <!-- Notification Bell -->
    <div class="notification-bell" id="notification-bell">
      üîî
      <div class="notification-count" id="notification-count" style="display: none;">0</div>
    </div>
    
    <div class="search-container">
      <i class="search-icon" id="search-toggle">üîç</i>
      <input type="text" id="search-bar" placeholder="Search products...">
      <div id="search-results"></div>
    </div>
    <div class="account-dropdown">
      <i class="account-icon" id="account-toggle">üë§</i>
      <div class="dropdown-menu" id="account-menu">
        <a href="account.html">Account</a>
        <a href="login.html">Log In</a>
        <a href="logout.html">Log Out</a>
      </div>
    </div>
  </div>
</header>

<!-- Hero Section -->
<section class="hero">
  <div class="hero-text">
    <h1>Discover, Shop, Enjoy a <br>Seamless Experience</h1>
    <div class="hero-buttons">
      <a href="categories.html" class="btn">Shop Now</a>
      <a href="listing.html" class="btn">Post Now</a>
    </div>
  </div>
  <div class="hero-image">
    <img src="first.png" alt="Shopping Image">
  </div>
</section>

<!-- Featured Items -->
<section class="featured" id="categories">
  <h2>Featured Items</h2>
  <div id="featured-grid" class="product-grid">
    <p>Loading featured products...</p>
  </div>
</section>

<!-- About Us Section -->
<section class="about-us" id="about">
  <div class="about-images">
    <img src="about1.jpg" alt="About Image 1" class="img1">
    <img src="about2.png" alt="About Image 2" class="img2">
  </div>
  <div class="about-content">
    <h2>About Us</h2>
    <p>
      College Market is your one-stop platform for buying and selling
      products within the college community. We aim to make transactions
      seamless and convenient for students.
    </p>
    <a href="about.html" class="btn about-btn">More</a>
  </div>
</section>

<!-- FOOTER -->
<footer class="footer">
  <div class="footer-logo"><img src="logo.png" alt="Ngolay Logo"></div>
  <div class="footer-links">
    <div class="footer-section">
      <h3>Company</h3>
      <a href="about.html">About Us</a>
      <a href="contact.html">Contact</a>
    </div>
    <div class="footer-section">
      <h3>Our Information</h3>
      <a href="terms.html">Terms</a>
      <a href="FAQ.html">FAQ</a>
    </div>
  </div>
  <div class="footer-bottom"><p>¬© 2025 Ngolay. All Rights Reserved</p></div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, orderBy, limit, getDocs, addDoc, onSnapshot, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCJfAyK_wma5RaTv6DODRgCDExnFuLXK00",
  authDomain: "ngolay-project.firebaseapp.com",
  projectId: "ngolay-project",
  storageBucket: "ngolay-project.appspot.com",
  messagingSenderId: "236457585222",
  appId: "1:236457585222:web:9133bb46a97ef678d23847"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUserUid = null;
let unreadNotificationsCount = 0;

function showNotification(msg) {
  const notif = document.getElementById('global-notification');
  if (notif) {
    notif.textContent = msg;
    notif.style.display = 'block';
    setTimeout(() => notif.style.display = 'none', 5000);
  }
}

function updateNotificationCount(count) {
  const notificationCount = document.getElementById('notification-count');
  const notificationBell = document.getElementById('notification-bell');
  if (count > 0) {
    notificationCount.textContent = count;
    notificationCount.style.display = 'flex';
    notificationBell.innerHTML = 'üîî';
  } else {
    notificationCount.style.display = 'none';
    notificationBell.innerHTML = 'üîï';
  }
  unreadNotificationsCount = count;
}

function setupNotificationListener() {
  if (!currentUserUid) return;
  const sellerNotifQuery = query(
    collection(db, "notifications"), 
    where("sellerId", "==", currentUserUid),
    where("read", "==", false)
  );
  onSnapshot(sellerNotifQuery, (snapshot) => {
    let sellerNotificationCount = snapshot.size;
    snapshot.docChanges().forEach((change) => {
      if (change.type === "added") {
        const notification = change.doc.data();
        showNotification(`üõí New order received! ${notification.message}`);
      }
    });
    updateTotalNotificationCount(sellerNotificationCount);
  });

  const buyerOrdersQuery = query(
    collection(db, "orders"),
    where("userId", "==", currentUserUid),
    where("meetingNotified", "==", false)
  );
  onSnapshot(buyerOrdersQuery, (snapshot) => {
    let buyerNotificationCount = 0;
    snapshot.docChanges().forEach((change) => {
      if (change.type === "modified" || change.type === "added") {
        const order = change.doc.data();
        if (order.meeting && !order.meetingNotified) {
          buyerNotificationCount++;
          showNotification(`üìÖ Meeting scheduled for your order!`);
        }
      }
    });
    updateTotalNotificationCount(buyerNotificationCount);
  });
}

function updateTotalNotificationCount(additionalCount = 0) {
  const totalCount = additionalCount;
  updateNotificationCount(totalCount);
}

document.getElementById('notification-bell').addEventListener('click', function() {
  if (currentUserUid) {
    window.location.href = 'dashboard.html';
  } else {
    showNotification('Please log in to view notifications');
  }
});

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUserUid = user.uid;
    setupNotificationListener();
  } else {
    updateNotificationCount(0);
  }
});

const searchToggle = document.getElementById('search-toggle');
const searchBar = document.getElementById('search-bar');
const searchResults = document.getElementById('search-results');
const accountToggle = document.getElementById('account-toggle');
const accountMenu = document.getElementById('account-menu');

searchToggle.addEventListener('click', () => {
  searchBar.style.display = searchBar.style.display === 'block' ? 'none' : 'block';
  if(searchBar.style.display === 'block') searchBar.focus();
});
accountToggle.addEventListener('click', e => {
  e.stopPropagation();
  accountMenu.style.display = accountMenu.style.display === 'block' ? 'none' : 'block';
});
document.addEventListener('click', e => {
  if (accountMenu.style.display === 'block' && !accountMenu.contains(e.target) && e.target !== accountToggle) {
    accountMenu.style.display = 'none';
  }
});

searchBar.addEventListener('input', async () => {
  const queryText = searchBar.value.trim().toLowerCase();
  searchResults.innerHTML = '';
  if (!queryText) { searchResults.style.display = 'none'; return; }

  const snapshot = await getDocs(collection(db, "products"));
  const matched = snapshot.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(p => p.name.toLowerCase().includes(queryText));

  if (matched.length === 0) searchResults.innerHTML = '<div>No products found.</div>';
  else matched.forEach(p => {
    const div = document.createElement('div');
    div.textContent = `${p.name} (${p.category})`;
    div.addEventListener('click', () => {
      sessionStorage.setItem('currentProduct', JSON.stringify(p));
      window.location.href = `product_detail.html?id=${p.id}`;
    });
    searchResults.appendChild(div);
  });
  searchResults.style.display = 'block';
});

const featuredGrid = document.getElementById('featured-grid');
async function loadFeaturedProducts(){
  featuredGrid.innerHTML = "<p>Loading...</p>";
  const q = query(collection(db,'products'), orderBy('postedTimestamp','desc'), limit(8));
  const snapshot = await getDocs(q);
  featuredGrid.innerHTML = '';
  if(snapshot.empty){featuredGrid.innerHTML="<p>No featured items yet.</p>"; return;}

  snapshot.forEach(docSnap => {
    const p = docSnap.data();
    let imgSrc = 'placeholder.jpg';
    if(p.images && p.images.length>0){imgSrc = p.images[0].startsWith('data:image') ? p.images[0] : p.images[0];}

    const card = document.createElement('div');
    card.className='product-card';
    card.innerHTML=`
      <a href="#" class="product-link"><img src="${imgSrc}" alt="${p.name}"></a>
      <h3>${p.name}</h3>
      <p>Nu. ${p.price.toFixed(2)}</p>
      <div class="product-actions">
        <button class="cart-btn">üõí</button>
        <button class="wishlist-btn">‚ù§Ô∏è</button>
      </div>
    `;
    featuredGrid.appendChild(card);

    card.querySelector('.product-link').addEventListener('click', e=>{
      e.preventDefault();
      window.location.href = `product_detail.html?id=${docSnap.id}`;
    });

    card.querySelector('.wishlist-btn').addEventListener('click', async e=>{
      e.preventDefault();
      if (!currentUserUid) {
        showNotification('Please log in to add to wishlist!');
        return;
      }
      const wishlistQuery = query(collection(db, 'wishlist'));
      const wishlistSnapshot = await getDocs(wishlistQuery);
      const existingWishlist = wishlistSnapshot.docs.find(doc => 
        doc.data().id === docSnap.id && doc.data().userId === currentUserUid
      );
      if(!existingWishlist){
        await addDoc(collection(db,'wishlist'), { id: docSnap.id, ...p, userId: currentUserUid, addedAt: new Date() });
        showNotification(`‚úÖ ${p.name} added to wishlist!`);
      } else {
        showNotification(`‚ÑπÔ∏è ${p.name} already in wishlist!`);
      }
    });
    
    card.querySelector('.cart-btn').addEventListener('click', async e=>{
      e.preventDefault();
      if (!currentUserUid) {
        showNotification('Please log in to add to cart!');
        return;
      }
      const cartQuery = query(collection(db, 'cart'));
      const cartSnapshot = await getDocs(cartQuery);
      const existingCart = cartSnapshot.docs.find(doc => 
        doc.data().id === docSnap.id && doc.data().userId === currentUserUid
      );
      if(!existingCart) {
        await addDoc(collection(db,'cart'), { id: docSnap.id, ...p, userId: currentUserUid, addedAt: new Date() });
        showNotification(`‚úÖ ${p.name} added to cart!`);
      } else {
        showNotification(`‚ÑπÔ∏è ${p.name} already in cart!`);
      }
    });
  });
}
loadFeaturedProducts();
</script>
</body>
</html>

