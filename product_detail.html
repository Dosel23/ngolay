<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ngolay | Product Detail</title>
  <link rel="stylesheet" href="product_detail.css">
  <style>
    /* Thumbnail row for Base64 images - Updated with larger thumbnails */
    #image-row { 
      display: flex; 
      gap: 15px; 
      overflow-x: auto; 
      margin-bottom: 20px; 
      justify-content: center;
      flex-wrap: wrap;
    }
    #image-row img { 
      width: 180px; 
      height: 180px; 
      object-fit: cover; 
      border-radius: 6px; 
      cursor: pointer;
      transition: transform 0.3s ease;
    }
    #image-row img:hover {
      transform: scale(1.05);
    }
    /* Removed main-image styles since we're removing the big image */

    /* Search Results Dropdown */
    #search-results { 
      display: none; 
      background: white; 
      color: black; 
      position: absolute; 
      top: 35px; 
      right: 0; 
      max-height: 300px; 
      overflow-y: auto; 
      width: 250px; 
      border-radius: 5px; 
      z-index: 20; 
      padding: 5px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #search-results div { 
      padding: 5px; 
      cursor: pointer; 
      border-bottom: 1px solid #ddd; 
    }
    #search-results div:hover { 
      background-color: #eee; 
    }

    /* Account Dropdown */
    .dropdown-menu { 
      display: none; 
      position: absolute; 
      top: 35px; 
      right: 0; 
      background: white; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
      z-index: 20; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .dropdown-menu a { 
      display: block; 
      padding: 10px; 
      text-decoration: none; 
      color: #656283; 
    }
    .dropdown-menu a:hover { 
      background-color: #eee; 
    }

    /* Search input */
    #search-bar { 
      display: none; 
      padding: 5px; 
      border-radius: 5px; 
      border: 1px solid #ccc; 
      margin-left: 5px; 
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <img src="logo.png" alt="Ngolay Logo">
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="categories.html" class="active">Categories</a>
      <a href="cart.html">Cart</a>
      <a href="wishlist.html">Wishlist</a>
    </nav>
    <div class="header-icons" style="position: relative;">
      <!-- Search -->
      <i class="search-icon" id="search-toggle">üîç</i>
      <input type="text" id="search-bar" placeholder="Search products...">
      <div id="search-results"></div>

      <!-- Account Dropdown -->
      <i class="account-icon" id="account-toggle">üë§</i>
      <div class="dropdown-menu" id="account-menu">
        <a href="account.html">Account</a>
        <a href="login.html">Log In</a>
        <a href="logout.html">Log Out</a>
      </div>
    </div>
  </header>

  <!-- Product Detail Section -->
  <section class="product_detail">
    <h2>PRODUCT DETAIL</h2>
    <!-- Removed the main-image element -->
    <div class="image-row" id="image-row"></div>
    <div class="product-info" id="product-info"></div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-logo">
      <img src="logo.png" alt="Ngolay Logo">
    </div>
    <div class="footer-links">
      <div class="footer-section">
        <h3>Company</h3>
        <a href="about.html">About Us</a>
        <a href="contact.html">Contact</a>
      </div>
      <div class="footer-section">
        <h3>Our Information</h3>
        <a href="terms.html">Terms and Condition</a>
        <a href="faq.html">FAQ</a>
      </div>
    </div>
    <div class="footer-bottom">
      <p>¬© 2025 Ngolay. All Rights Reserved</p>
    </div>
  </footer>

  <!-- Firebase SDK + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ---------------------------
    // Firebase config
    // ---------------------------
    const firebaseConfig = {
      apiKey: "AIzaSyCJfAyK_wma5RaTv6DODRgCDExnFuLXK00",
      authDomain: "ngolay-project.firebaseapp.com",
      projectId: "ngolay-project",
      storageBucket: "ngolay-project.appspot.com",
      messagingSenderId: "236457585222",
      appId: "1:236457585222:web:9133bb46a97ef678d23847",
      measurementId: "G-34BC1Z5PPM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const productId = params.get("id");
    let currentUserUid = null;

    onAuthStateChanged(auth, user => {
      if(user) currentUserUid = user.uid;
      loadProduct();
    });

    function compressBase64(base64Str, maxWidth = 800, quality = 0.7) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          const ratio = Math.min(maxWidth / img.width, 1);
          const canvas = document.createElement("canvas");
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          resolve(canvas.toDataURL("image/jpeg", quality));
        };
        img.src = base64Str;
      });
    }

    async function loadProduct() {
      if(!productId){
        alert("No product selected!");
        window.location.href = "categories.html";
        return;
      }
      const productRef = doc(db, "products", productId);
      const productSnap = await getDoc(productRef);
      if(!productSnap.exists()){
        alert("Product not found!");
        window.location.href = "categories.html";
        return;
      }

      const product = productSnap.data();
      const imageRow = document.getElementById("image-row");
      imageRow.innerHTML = "";

      // Load all product images as larger thumbnails
      if(product.images?.length > 0){
        const compressedImages = await Promise.all(product.images.map(img => compressBase64(img)));
        compressedImages.forEach((img, idx) => {
          const thumb = document.createElement("img");
          thumb.src = img;
          thumb.alt = product.name + " " + (idx+1);
          imageRow.appendChild(thumb);
        });
      }

      const infoDiv = document.getElementById("product-info");
      infoDiv.innerHTML = `
        <p><strong>Product Name:</strong> ${product.name}</p>
        <p><strong>Price:</strong> Nu. ${product.price}</p>
        <p><strong>Quantity:</strong> ${product.quantity || 1}</p>
        <p><strong>Category:</strong> ${product.category}</p>
        <p><strong>Size:</strong> ${product.size || 'N/A'}</p>
        <p><strong>Description:</strong> ${product.shortDescription || 'No description'}</p>

        <div class="actions">
          <a href="#" id="addCart" class="cart-icon">üõí</a>
          <a href="#" id="addWishlist" class="wishlist-icon">‚ô°</a>
          <a href="#" id="buyNow" class="buy-btn">BUY NOW</a>
        </div>
      `;

      document.getElementById("addCart").addEventListener("click", async e => {
        e.preventDefault();
        if(!currentUserUid){ alert("Please log in to add to cart."); return; }
        await addDoc(collection(db, "cart"), {...product, userId: currentUserUid, quantity: 1});
        alert(`${product.name} added to cart!`);
      });

      document.getElementById("addWishlist").addEventListener("click", async e => {
        e.preventDefault();
        if(!currentUserUid){ alert("Please log in to add to wishlist."); return; }
        await addDoc(collection(db, "wishlist"), {...product, userId: currentUserUid});
        alert(`${product.name} added to wishlist!`);
      });

      document.getElementById("buyNow").addEventListener("click", () => {
        window.location.href = `checkout.html?productId=${productId}`;
      });
    }

    // ---------------------------
    // Search functionality
    // ---------------------------
    const searchToggle = document.getElementById('search-toggle');
    const searchBar = document.getElementById('search-bar');
    const searchResults = document.getElementById('search-results');
    searchToggle.addEventListener('click', () => {
      searchBar.style.display = searchBar.style.display === 'block' ? 'none' : 'block';
      if(searchBar.style.display === 'block') searchBar.focus();
    });

    searchBar.addEventListener('input', async () => {
      const queryText = searchBar.value.trim().toLowerCase();
      searchResults.innerHTML = '';
      if (!queryText) { searchResults.style.display = 'none'; return; }

      const snapshot = await getDocs(collection(db, "products"));
      const matched = snapshot.docs
        .map(d => ({ id: d.id, ...d.data() }))
        .filter(p => p.name.toLowerCase().includes(queryText));

      if (matched.length === 0) searchResults.innerHTML = '<div>No products found.</div>';
      else matched.forEach(p => {
        const div = document.createElement('div');
        div.textContent = `${p.name} (${p.category})`;
        div.addEventListener('click', () => {
          window.location.href = `product_detail.html?id=${p.id}`;
        });
        searchResults.appendChild(div);
      });
      searchResults.style.display = 'block';
    });

    // ---------------------------
    // Account dropdown
    // ---------------------------
    const accountToggle = document.getElementById('account-toggle');
    const accountMenu = document.getElementById('account-menu');
    accountToggle.addEventListener('click', e => {
      e.stopPropagation();
      accountMenu.style.display = accountMenu.style.display === 'block' ? 'none' : 'block';
    });
    document.addEventListener('click', e => {
      if(accountMenu.style.display === 'block' && !accountMenu.contains(e.target) && e.target !== accountToggle){
        accountMenu.style.display = 'none';
      }
    });

  </script>
</body>
</html>
