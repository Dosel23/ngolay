<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Listings - Ngolay</title>
<link rel="stylesheet" href="all_categories.css">
<style>
/* HEADER/FOOTER already in all_categories.css from homepage style */

/* Listing-specific overrides */
.listings-container{display:flex;flex-wrap:wrap;max-width:1200px;margin:30px auto;gap:40px;padding:0 20px;}
.post-product-section{flex:1 1 320px;padding:20px;background:white;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.my-listings-section{flex:2 1 600px;padding:20px;}
.form-group{margin-bottom:15px;}
.form-group label{display:block;margin-bottom:5px;font-weight:bold;color:#444;}
.form-group input:not([type="file"]), .form-group textarea, .form-group select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;}
.form-group input[type="file"]{border:1px solid #ccc;padding:8px;width:100%;border-radius:4px;}
.image-group .small{font-size:0.85em;color:#777;margin-bottom:5px;}
.image-group{margin-top:15px;padding-top:10px;border-top:1px dashed #ccc;}
.post-btn{width:100%;padding:10px;background-color:#656283;color:white;border:none;cursor:pointer;font-weight:bold;margin-top:10px;}
.title-with-count{display:flex;align-items:center;gap:10px;}
.count-badge{background-color:#656283;color:white;padding:4px 10px;border-radius:20px;font-size:0.9em;font-weight:bold;}
.info-text{font-size:0.95em;color:#555;margin-bottom:20px;line-height:1.4;padding-top:5px;}
.listings-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px;}
.listing-card{background:white;border:1px solid #e0e0e0;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05);padding:15px;display:flex;flex-direction:column;gap:10px;}
.listing-image-wrapper{display:flex;gap:5px;overflow-x:auto;padding-bottom:5px;}
.listing-image-wrapper img{width:80px;height:80px;object-fit:cover;border-radius:4px;flex-shrink:0;}
.listing-dates{font-size:0.85em;margin-bottom:5px;color:#777;}
.status-info{font-weight:bold;margin-top:10px;padding:5px;border-radius:4px;font-size:0.85em;text-align:center;}
.status-info.expiring{background:#fff3cd;color:#856404;}
.status-info.ok{background:#d4edda;color:#155724;}
.listing-actions{display:flex;justify-content:space-between;margin-top:10px;width:100%;}
.listing-actions button{padding:8px 12px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;transition:0.2s;}
.delete-btn{background:#dc3545;color:white;}
.renew-btn{background:#007bff;color:white;}

/* Color input styling */
.color-input-group {display:flex;gap:10px;align-items:center;margin-top:5px;}
.color-input-group input {flex:1;}
.add-color-btn {background:#656283;color:white;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;}
.color-tags {display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;}
.color-tag {background:#e0e0e0;padding:2px 8px;border-radius:10px;font-size:0.8em;display:flex;align-items:center;gap:5px;}
.remove-color {cursor:pointer;color:#ff4444;}
</style>
</head>
<body>

<!-- HEADER with search & account dropdown (homepage style) -->
<header class="header">
  <div class="logo"><img src="logo.png" alt="Ngolay Logo"></div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="categories.html">Categories</a>
    <a href="cart.html">Cart</a>
    <a href="wishlist.html">Wishlist</a>
  </nav>
  <div class="header-icons">
    <div class="search-container">
      <i class="search-icon" id="search-toggle">üîç</i>
      <input type="text" id="search-bar" placeholder="Search products...">
      <div id="search-results"></div>
    </div>
    <div class="account-dropdown">
      <i class="account-icon" id="account-toggle">üë§</i>
      <div class="dropdown-menu" id="account-menu">
        <a href="account.html">Account</a>
        <a href="login.html">Log In</a>
        <a href="logout.html">Log Out</a>
      </div>
    </div>
  </div>
</header>

<main class="listings-container">
  <!-- Post Product Section -->
  <section class="post-product-section">
    <h2>Post Product</h2>
    <form id="product-post-form">
      <div class="form-group">
        <label for="p-name">Product Name</label>
        <input type="text" id="p-name" placeholder="e.g., White T-shirt" required>
      </div>
      <div class="form-group">
        <label for="p-category">Category</label>
        <select id="p-category" required>
          <option value="" disabled selected>Select a Category</option>
          <option value="Stationary">Stationary</option>
          <option value="Clothes">Clothes</option>
          <option value="Beauty">Beauty</option>
          <option value="Electronic">Electronic</option>
          <option value="Food">Food</option>
          <option value="Miscellanies">Miscellanies</option>
        </select>
      </div>
      <div class="form-group">
        <label for="p-size">Available Sizes (comma separated)</label>
        <input type="text" id="p-size" placeholder="e.g., S, M, L, XL">
      </div>
      <div class="form-group">
        <label for="p-color">Available Colors</label>
        <div class="color-input-group">
          <input type="text" id="p-color-input" placeholder="e.g., Red, Blue, Black">
          <button type="button" class="add-color-btn" id="add-color-btn">Add Color</button>
        </div>
        <div class="color-tags" id="color-tags">
          <!-- Color tags will be added here dynamically -->
        </div>
      </div>
      <div class="form-group">
        <label for="p-price">Price (Nu.)</label>
        <input type="number" id="p-price" step="0.01" required>
      </div>
      <div class="form-group">
        <label for="p-quantity">Quantity Available</label>
        <input type="number" id="p-quantity" value="1" min="1" required>
      </div>
      <div class="form-group">
        <label for="p-description">Description</label>
        <textarea id="p-description" rows="3" placeholder="Optional"></textarea>
      </div>
      <div class="form-group image-group">
        <label>Product Pictures</label>
        <div class="small">Select up to 5 images</div>
        <input type="file" class="p-image-file" accept="image/*" required>
        <input type="file" class="p-image-file" accept="image/*">
        <input type="file" class="p-image-file" accept="image/*">
        <input type="file" class="p-image-file" accept="image/*">
        <input type="file" class="p-image-file" accept="image/*">
      </div>
      <button type="submit" class="post-btn">Post</button>
    </form>
  </section>

  <!-- My Listings Section -->
  <section class="my-listings-section">
    <h2 class="title-with-count">My Listings <span id="product-count" class="count-badge">0</span></h2>
    <p class="info-text">Products you posted appear here. Tip: Renew extends life by 30 days. Deleting removes an item immediately.</p>
    <div id="listings-dashboard" class="listings-grid">
      <p id="no-products-message">You have no active listings. Post one now!</p>
    </div>
  </section>
</main>

<!-- FOOTER (homepage style) -->
<footer class="footer">
  <div class="footer-logo"><img src="logo.png" alt="Ngolay Logo"></div>
  <div class="footer-links">
    <div class="footer-section">
      <h3>Company</h3>
      <a href="about.html">About Us</a>
      <a href="contact.html">Contact</a>
    </div>
    <div class="footer-section">
      <h3>Our Information</h3>
      <a href="terms.html">Terms</a>
      <a href="FAQ.html">FAQ</a>
    </div>
  </div>
  <div class="footer-bottom"><p>¬© 2025 Ngolay. All Rights Reserved</p></div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCJfAyK_wma5RaTv6DODRgCDExnFuLXK00",
  authDomain: "ngolay-project.firebaseapp.com",
  projectId: "ngolay-project",
  storageBucket: "ngolay-project.appspot.com",
  messagingSenderId: "236457585222",
  appId: "1:236457585222:web:9133bb46a97ef678d23847"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Header search & account dropdown
const searchToggle = document.getElementById('search-toggle');
const searchBar = document.getElementById('search-bar');
const searchResults = document.getElementById('search-results');
const accountToggle = document.getElementById('account-toggle');
const accountMenu = document.getElementById('account-menu');
searchToggle.addEventListener('click', () => {
  searchBar.style.display = searchBar.style.display === 'block' ? 'none' : 'block';
  if(searchBar.style.display === 'block') searchBar.focus();
});
accountToggle.addEventListener('click', e => {
  e.stopPropagation();
  accountMenu.style.display = accountMenu.style.display === 'block' ? 'none' : 'block';
});
document.addEventListener('click', e => {
  if (accountMenu.style.display === 'block' && !accountMenu.contains(e.target) && e.target !== accountToggle) {
    accountMenu.style.display = 'none';
  }
});

// Color management
let selectedColors = [];
const colorInput = document.getElementById('p-color-input');
const addColorBtn = document.getElementById('add-color-btn');
const colorTags = document.getElementById('color-tags');

addColorBtn.addEventListener('click', () => {
  const color = colorInput.value.trim();
  if (color && !selectedColors.includes(color)) {
    selectedColors.push(color);
    updateColorTags();
    colorInput.value = '';
  }
});

function updateColorTags() {
  colorTags.innerHTML = '';
  selectedColors.forEach((color, index) => {
    const tag = document.createElement('div');
    tag.className = 'color-tag';
    tag.innerHTML = `
      ${color}
      <span class="remove-color" data-index="${index}">√ó</span>
    `;
    colorTags.appendChild(tag);
  });

  // Add remove event listeners
  document.querySelectorAll('.remove-color').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const index = parseInt(e.target.getAttribute('data-index'));
      selectedColors.splice(index, 1);
      updateColorTags();
    });
  });
}

// Listings logic
const form = document.getElementById('product-post-form');
const dashboard = document.getElementById('listings-dashboard');
const productCountSpan = document.getElementById('product-count');
const noProductsMessage = document.getElementById('no-products-message');
let currentUserUid = null;

onAuthStateChanged(auth, user => {
  if(user){
    currentUserUid = user.uid;
    loadListings();
  } else {
    alert("Please log in to post products.");
    window.location.href = "login.html";
  }
});

async function loadListings(){
  dashboard.innerHTML = '';
  const q = query(collection(db,'products'), where('sellerId','==',currentUserUid));
  const snapshot = await getDocs(q);
  const products = snapshot.docs.map(d=>({id:d.id,...d.data()}));
  productCountSpan.textContent = products.length;
  if(products.length===0){ noProductsMessage.style.display='block'; dashboard.appendChild(noProductsMessage); return; }
  noProductsMessage.style.display='none';
  products.forEach(product=>{
    let days = Math.round((product.deletionTimestamp - Date.now())/(24*60*60*1000));
    let statusClass = days<=7 ? 'expiring':'ok';
    let note = days<=7 ? `üîî Renew! Deletes in ${days} days.`:`Active. Deletes in ${days} days.`;
    const imagesHTML = (product.images||[]).map(img=>`<img src="${img}" alt="${product.name}">`).join('');
    
    // Display colors and sizes
    const colorsDisplay = product.colors && product.colors.length > 0 ? 
      `Colors: ${product.colors.join(', ')}` : 'No colors specified';
    const sizesDisplay = product.sizes && product.sizes.length > 0 ? 
      `Sizes: ${product.sizes.join(', ')}` : 'One Size';
    
    const card = document.createElement('div');
    card.className='listing-card';
    card.innerHTML=`
      <div class="listing-image-wrapper">${imagesHTML}</div>
      <div class="listing-details">
        <h3>${product.name}</h3>
        <div class="listing-dates">Posted: ${new Date(product.postedTimestamp).toLocaleDateString()} | Expires: <strong>${new Date(product.deletionTimestamp).toLocaleDateString()}</strong></div>
        <p>Category: <strong>${product.category}</strong></p>
        <p>${sizesDisplay}</p>
        <p>${colorsDisplay}</p>
        ${product.shortDescription?`<p>${product.shortDescription}</p>`:''}
        <p>Price: <strong>Nu. ${product.price}</strong></p>
        <p>Quantity: <strong>${product.quantity}</strong></p>
        <div class="status-info ${statusClass}">${note}</div>
        <div class="listing-actions">
          <button class="renew-btn" data-id="${product.id}">Renew Life</button>
          <button class="delete-btn" data-id="${product.id}">Remove</button>
        </div>
      </div>
    `;
    dashboard.appendChild(card);

    card.querySelector('.delete-btn').addEventListener('click', async e=>{
      e.preventDefault();
      if(confirm('Delete this listing?')){ await deleteDoc(doc(db,'products',product.id)); loadListings(); }
    });
    card.querySelector('.renew-btn').addEventListener('click', async e=>{
      e.preventDefault();
      await updateDoc(doc(db,'products',product.id), {deletionTimestamp: Date.now()+30*24*60*60*1000});
      alert('Renewed 30 days');
      loadListings();
    });
  });
}

// Post product handler (with compressed images)
async function compressAndConvert(file){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    const reader=new FileReader();
    reader.onload=e=>img.src=e.target.result;
    reader.onerror=err=>reject(err);
    reader.readAsDataURL(file);
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const maxDim=600;
      let w=img.width,h=img.height;
      if(w>h&&w>maxDim){h*=maxDim/w;w=maxDim;}
      else if(h>w&&h>maxDim){w*=maxDim/h;h=maxDim;}
      else if(w===h&&w>maxDim){w=h=maxDim;}
      canvas.width=w;canvas.height=h;
      const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,w,h);
      resolve(canvas.toDataURL('image/jpeg',0.7));
    };
  });
}

form?.addEventListener('submit', async e=>{
  e.preventDefault();
  if(!currentUserUid){alert('Not logged in'); return;}
  const files=document.querySelectorAll('.p-image-file');
  const images=[];
  for(const f of files){if(f.files[0]) images.push(await compressAndConvert(f.files[0]));}
  if(images.length===0){alert('Upload at least one image'); return;}
  
  // Process sizes (comma separated to array)
  const sizesInput = document.getElementById('p-size').value.trim();
  const sizes = sizesInput ? sizesInput.split(',').map(s => s.trim()).filter(s => s) : ['One Size'];
  
  const now=Date.now(), deletion=now+30*24*60*60*1000;
  await addDoc(collection(db,'products'),{
    name:document.getElementById('p-name').value,
    category:document.getElementById('p-category').value,
    sizes: sizes, // Store as array
    colors: selectedColors, // Store as array
    price:parseFloat(document.getElementById('p-price').value),
    quantity:parseInt(document.getElementById('p-quantity').value),
    shortDescription:document.getElementById('p-description').value.trim(),
    images,
    sellerId:currentUserUid,
    postedTimestamp:now,
    deletionTimestamp:deletion
  });
  
  // Reset form and colors
  form.reset();
  selectedColors = [];
  updateColorTags();
  loadListings();
});
</script>
</body>

</html>
